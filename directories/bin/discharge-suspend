#!/usr/bin/env bash
# Maintained in linux-config.org

# loop and check power levels every BAT_POWER_POLL_CYCLE seconds. When a certain
# threshold, BAT_POWER_SUSPEND_LEVEL, is reached then, unless there is
# a check file ~/.BAT_POWER_SUSPEND_SUSPEND, in which case we just repeat
# warnings, suspend in BAT_POWER_SUSPEND_TIME seconds.
# 
if [ ! -f /sys/class/power_supply/BAT0/status ];then
    exit 1;
fi

rm -f ~/.BAT_POWER_SUSPEND_SUSPEND
POLLCYCLE=${BAT_POWER_SUSPEND_POLL_CYCLE:-120}
SUSPENDTIME=${BAT_POWER_SUSPEND_TIME:-600};

BAT_POWER_SUSPENDING=false

while true; do
    sleep ${POLLCYCLE}
    mapfile -t batStats< <(cat /sys/class/power_supply/BAT0/{status,capacity})
    status=${batStats[0]}
    level=${batStats[1]}
    if [ ${status} = "Discharging" ]; then
        if [ ${level} -le ${BAT_POWER_SUSPEND_LEVEL:-30} ]; then
            # unless we're overriding the auto suspend then check if we should
            if [ ! -f ~/.BAT_POWER_SUSPEND_SUSPEND ]; then
                #if we're already in the process of supending see if its time to suspend
                if [ ${BAT_POWER_SUSPENDING} = true ]; then
                    if [ ${SECONDS} -ge ${SUSPENDTIME} ];then
                        notify-send "** SUSPENDING in 10 SECONDS : no escape.  **"
                        beepy
                        sleep 10
                        systemctl suspend
                        BAT_POWER_SUSPENDING=false
                    else
                        notify-send "**WARNING**" "Battery low: suspending in about $((${SUSPENDTIME}-${SECONDS})) seconds."
                    fi
                else
                    # initiate the suspending period
                    BAT_POWER_SUSPENDING=true
                    SECONDS=0
                    notify-send "**WARNING**" "Battery low. Suspending in ${SUSPENDTIME} seconds."
                    beepy
                fi
            else
                # since suspend is being overridden, just warn of low battery
                BAT_POWER_SUSPENDING=false;
                notify-send "**WARNING**" "Battery low: ${level}%."
            fi
        fi
    else
        # we're not discharging so cancel any suspend operations
        BAT_POWER_SUSPENDING=false
    fi
done
