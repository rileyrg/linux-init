#!/usr/bin/env bash
# Maintained in linux-config.org

if [ ! -f /sys/class/power_supply/BAT0/status ];then
    exit 1;
fi

rm -f ~/.BAT_POWER_SUSPEND_SUSPEND
pollCycle=${BAT_POWER_POLL_CYCLE:-120}
orgPollCycle=${pollCycle}
suspendTime=${BAT_POWER_SUSPEND_TIME:-600};

while true; do
    sleep ${pollCycle}
    mapfile -t batStats< <(cat /sys/class/power_supply/BAT0/{status,capacity})
    status=${batStats[0]}
    level=${batStats[1]}
    if [ ${status} = "Discharging" ]; then
        if [ ${level} -le ${BAT_POWER_SUSPEND_LEVEL:-30} ]; then
            if [ -f ~/.BAT_POWER_LOW ]; then
                rm  ~/.BAT_POWER_LOW
                pollCycle=${orgPollCycle}
                if [ ! -f ~/.BAT_POWER_SUSPEND_SUSPEND ];then
                    notify-send "** SUSPENDING in 60 SECONDS **"
                    beepy
                    sleep 60
                    systemctl suspend
                fi
            else
                if [ ! -f ~/.BAT_POWER_SUSPEND_SUSPEND ];then
                    touch ~/.BAT_POWER_LOW
                    pollCycle=${suspendTime}
                    notify-send "**WARNING**" "Battery low. Suspending in ${pollCycle} seconds."
                    beepy
                else
                    notify-send "**WARNING**" "Battery low: ${level}%."
                fi
            fi
        fi
    else
        rm -f ~/.BAT_POWER_LOW
    fi
done
