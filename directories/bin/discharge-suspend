#!/usr/bin/env bash
# Maintained in linux-config.org

if [ ! -f /sys/class/power_supply/BAT0/status ];then
    exit 1;
fi

rm -f ~/.BAT_POWER_SUSPEND_SUSPEND
POLLCYCLE=${BAT_POWER_SUSPEND_POLL_CYCLE:-120}
SUSPENDTIME=${BAT_POWER_SUSPEND_TIME:-600};

BAT_POWER_SUSPENDING=false

while true; do
    sleep ${POLLCYCLE}
    mapfile -t batStats< <(cat /sys/class/power_supply/BAT0/{status,capacity})
    status=${batStats[0]}
    level=${batStats[1]}
    if [ ${status} = "Discharging" ]; then
        if [ ${level} -le ${BAT_POWER_SUSPEND_LEVEL:-30} ]; then
            if [ ! -f ~/.BAT_POWER_SUSPEND_SUSPEND ]; then
                if [ ${BAT_POWER_SUSPENDING} = true ]; then
                    if [ ${SECONDS} -ge ${SUSPENDTIME} ];then
                        notify-send "** SUSPENDING in 30 SECONDS **"
                        beepy
                        sleep 30
                        systemctl suspend
                        BAT_POWER_SUSPENDING=false
                        SECONDS=0;
                    else
                        notify-send "**WARNING**" "Battery low: suspending in about $((${SUSPENDTIME}-${SECONDS})) seconds."
                    fi
                else
                    BAT_POWER_SUSPENDING=true
                    SECONDS=0
                    notify-send "**WARNING**" "Battery low. Suspending in ${SUSPENDTIME} seconds."
                    beepy
                fi
            else
                BAT_POWER_SUSPENDING=false;
                notify-send "**WARNING**" "Battery low: ${level}%."
            fi
        fi
    else
        BAT_POWER_SUSPENDING=false
    fi
done
