#!/usr/bin/env bash
#Maintained in linux-config.org
colors=(green orange orange red red)
FANSPEED_DIVISOR=${FANSPEED_DIVISOR:-1000}
while true;do
    f=$(sensors | \grep -i "^fan" | awk '{print $1,$2}' | sed 's/fan//g' | sed 's/: /:/')
    readarray -t fans <<< $(echo -e "${f}")
    output=""
    for fan in "${fans[@]}"; do
        IFS=: read -r fanid rpm <<< "${fan}"
        if [ ! "${rpm}" = "0" ]; then
            color=${colors[$(( rpm / FANSPEED_DIVISOR))]};
            output="${output}<span color='gray'>${fanid}:</span><span color='${color}'>${rpm} </span>"
        fi
    done
    sleep ${WAYBAR_FANSPEED_SLEEP:-2}
    echo $(jq --null-input --arg text "${output}" '{"text": $text}')
done
