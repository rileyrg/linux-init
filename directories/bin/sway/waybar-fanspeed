#!/usr/bin/env bash
#Maintained in linux-config.org
cd /sys/class/hwmon
curhwmon=""
output=""
while read -r fanfile ; do
    speed=$(cat "${fanfile}")
    if [ ! "${speed}" = "0" ]; then
        hwmon=$(sed 's@^[^0-9]*\([0-9]\+\).*@\1@' <<< "${fanfile}")
        if [ ! "${hwmon}" = "${curhwmon}" ]; then
            curhwmon="${hwmon}"
            output="${output}<span color='gold'>hwmon${hwmon}</span>:"
        fi
        fanid=$(sed 's/[^0-9]//g' <<<  $(basename "${fanfile}"))
        output="${output}<span color='orange'>${fanid} </span><span color='green'>${speed} </span>"
    fi
done < <(find -L . -maxdepth 2 -type f -name "fan*input" 2> /dev/null | sort)
text="${output:-No Active Fans Read}"
tooltip="Buzz"
echo $(jq --null-input --arg text "${text}" --arg tooltip "${tooltip}" '{"text": $text,"tooltip":$tooltip'})
