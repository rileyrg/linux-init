#!/usr/bin/env bash
#Maintained in linux-config.org
if [[ -z ${WAYBAR_FANSPEED_COLORS} ]];then
    WAYBAR_FANSPEED_COLORS=(green green green gold orange red)
fi
numColors=${#WAYBAR_FANSPEED_COLORS[@]}
WAYBAR_FANSPEED_MAXRPM=${WAYBAR_FANSPEED_MAXRPM:-4000}
WAYBAR_FANSPEED_DIVISOR=$((WAYBAR_FANSPEED_MAXRPM / numColors))
while true;do
    readarray -t fans <<< $(sensors | \grep -i "^fan" | awk '{print $1,$2}' | sed 's/fan// ; s/: /:/')
    output=""
    for fan in "${fans[@]}"; do
        IFS=: read -r fanid rpm <<< "${fan}"
        if [ ! "${rpm}" = "0" ]; then
            color=${WAYBAR_FANSPEED_COLORS[$(( rpm / WAYBAR_FANSPEED_DIVISOR))]};
            output="${output}<span color='gold'>󰈐 ${fanid}:</span><span color='${color}'>${rpm} </span>"
        fi
    done
    echo ${output:-${WAYBAR_FANSPEED_NOFANSTEXT:-"No 󰈐 Spinning"}}
    sleep ${WAYBAR_FANSPEED_POLLTIME:-2}
done
