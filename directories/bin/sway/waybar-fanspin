#!/usr/bin/env bash
#Maintained in linux-config.org
#!/usr/bin/env bash

# https://github.com/nirabyte/dotfiles/blob/main/waybar/scripts/fan-spin.sh

while read -r fanfile; do
    speed=$(cat "$fanfile" 2>/dev/null)
    (( speed > max_speed )) && max_speed=$speed
    (( speed > 0 )) && (( active_count++ ))
done < <(find /sys/class/hwmon -type f -name "fan*_input" 2>/dev/null)

if (( max_speed == 0 )); then
    echo "Û∞àê 0 RPM"
    sleep 1
    continue
fi

if (( max_speed <= mid_rpm )); then
    fanSpeed=$(awk -v r="$max_speed" -v m="$mid_rpm" 'BEGIN { printf "%.2f", (r/m) * 0.5 }')
else
    fanSpeed=$(awk -v r="$max_speed" -v m="$mid_rpm" -v M="$max_rpm" \\
        'BEGIN { s = 0.5 + (r-m)/(M-m)*0.5; if (s>1) s=1; printf "%.2f", s }')
fi

delay=$(awk -v fs="$fanSpeed" -v mn="$min_delay" -v mx="$max_delay" \\
    'BEGIN { d = mx - fs*(mx - mn); printf "%.3f", d }')

for frame in "${frames[@]}"; do
    if (( active_count > 1 )); then
        echo "$frame ${max_speed} RPM ($active_count fans)"
    else
        echo "$frame ${max_speed} RPM"
    fi
    sleep "$delay"
done
