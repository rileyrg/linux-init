#!/usr/bin/env bash
#Maintained in linux-config.org
#!/usr/bin/env bash

# https://github.com/nirabyte/dotfiles/blob/main/waybar/scripts/fan-spin.sh

while true; do
  # Get CPU fan RPM from sensors
  rpm=$(sensors | awk '/cpu_fan:/ {print $2}' | tr -d 'RPM')

  # Ensure numeric
  if ! [[ "$rpm" =~ ^[0-9]+$ ]]; then
    rpm=0
  fi

  # If RPM = 0, show static fan icon with 0 RPM
  if (( rpm == 0 )); then
    echo " 󰈐 0 RPM"
    sleep 1
    continue
  fi

  # Map RPM to speed multiplier using your breakpoints
  min_rpm=0
  mid_rpm=1800
  max_rpm=3500

  if (( rpm <= mid_rpm )); then
    fanSpeed=$(awk -v r="$rpm" -v m="$mid_rpm" \
      'BEGIN{ printf "%.2f", (r/m) * 0.5 }')
  else
    fanSpeed=$(awk -v r="$rpm" -v m="$mid_rpm" -v M="$max_rpm" \
      'BEGIN{ s = 0.5 + (r-m)/(M-m)*0.5; if(s>1) s=1; printf "%.2f", s }')
  fi

  # Convert fanSpeed to delay (higher speed → lower delay)
  min_delay=0.05
  max_delay=0.4

  delay=$(awk -v fs="$fanSpeed" -v mn="$min_delay" -v mx="$max_delay" \
    'BEGIN{ d = mx - fs*(mx - mn); printf "%.3f", d }')

  # Spinner frames
  frames=(" |" " /" " —" " \\")

  # Print each frame with RPM
  for f in "${frames[@]}"; do
    echo "$f $rpm RPM"
    sleep "$delay"
  done
done
